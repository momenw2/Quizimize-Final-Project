<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <style>
      /* Manage Faculties Page Styles */
      .manage-faculties-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e0e0e0;
      }

      .page-header h1 {
        margin: 0;
        color: #333;
      }

      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #4a90e2;
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border: 1px solid #4a90e2;
        border-radius: 4px;
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background-color: #4a90e2;
        color: white;
      }

      .faculties-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .faculty-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .faculty-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .faculty-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .faculty-header h3 {
        margin: 0;
        color: #333;
        font-size: 1.25rem;
      }

      .faculty-index {
        background: #4a90e2;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .faculty-description {
        color: #666;
        line-height: 1.5;
        margin-bottom: 1rem;
        min-height: 60px;
      }

      .faculty-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .meta-item {
        background: #f8f9fa;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #555;
      }

      .dean-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f0f7ff;
        border-radius: 4px;
        border-left: 3px solid #4a90e2;
      }

      .dean-avatar {
        width: 32px;
        height: 32px;
        background: #4a90e2;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
      }

      .dean-details {
        flex: 1;
      }

      .dean-name {
        font-weight: 500;
        color: #333;
        margin: 0 0 0.25rem 0;
      }

      .dean-role {
        font-size: 0.8rem;
        color: #666;
        margin: 0;
      }

      .no-dean {
        padding: 0.75rem;
        background: #f9f9f9;
        border-radius: 4px;
        color: #888;
        font-style: italic;
        margin-bottom: 1rem;
        text-align: center;
      }

      .faculty-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .action-btn {
        flex: 1;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        min-width: 120px;
      }

      .edit-btn {
        background-color: #4a90e2;
        color: white;
      }

      .edit-btn:hover {
        background-color: #357abd;
      }

      .delete-btn {
        background-color: #e74c3c;
        color: white;
      }

      .delete-btn:hover {
        background-color: #c0392b;
      }

      .view-btn {
        background-color: #2ecc71;
        color: white;
      }

      .view-btn:hover {
        background-color: #27ae60;
      }

      .assign-dean-btn {
        background-color: #9b59b6;
        color: white;
      }

      .assign-dean-btn:hover {
        background-color: #8e44ad;
      }

      .no-faculties {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 8px;
        border: 2px dashed #ddd;
      }

      .no-faculties h3 {
        color: #666;
        margin-bottom: 1rem;
      }

      .no-faculties p {
        color: #888;
        margin-bottom: 1.5rem;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        display: none;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
      }

      .close {
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #333;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4a90e2;
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
      }

      .dean-select-option {
        display: flex;
        align-items: center;
        padding: 0.5rem;
      }

      .dean-select-option span {
        margin-left: 0.5rem;
      }

      .dean-select-option small {
        margin-left: auto;
        color: #666;
        font-size: 0.8rem;
      }

      /* Loading States */
      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4a90e2;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .manage-faculties-container {
          padding: 1rem;
        }

        .faculties-grid {
          grid-template-columns: 1fr;
        }

        .faculty-actions {
          flex-direction: column;
        }

        .action-btn {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Main Content -->
    <div class="manage-faculties-container">
      <!-- Page Header -->
      <div class="page-header">
        <h1>Manage Faculties - <%= university.name %></h1>
        <a href="/universities/<%= university._id %>" class="back-button">
          ← Back to University
        </a>
      </div>

      <!-- Faculties Grid -->
      <% if (university.faculties && university.faculties.length > 0) { %>
      <div class="faculties-grid">
        <% university.faculties.forEach((faculty, index) => { %>
        <div class="faculty-card" data-faculty-index="<%= index %>">
          <div class="faculty-header">
            <h3><%= faculty.name %></h3>
            <span class="faculty-index">#<%= index + 1 %></span>
          </div>

          <% if (faculty.description) { %>
          <div class="faculty-description"><%= faculty.description %></div>
          <% } else { %>
          <div
            class="faculty-description"
            style="color: #999; font-style: italic"
          >
            No description provided
          </div>
          <% } %>

          <!-- Dean Information -->
          <% if (faculty.deanName) { %>
          <div class="dean-info">
            <div class="dean-avatar">
              <%= faculty.deanName.charAt(0).toUpperCase() %>
            </div>
            <div class="dean-details">
              <p class="dean-name"><%= faculty.deanName %></p>
              <p class="dean-role">Dean</p>
            </div>
          </div>
          <% } else { %>
          <div class="no-dean">No dean assigned</div>
          <% } %>

          <div class="faculty-meta">
            <div class="meta-item">
              Courses: <%= faculty.courses ? faculty.courses.length : 0 %>
            </div>
            <% if (faculty.contactEmail) { %>
            <div class="meta-item">Email: <%= faculty.contactEmail %></div>
            <% } %>
            <div class="meta-item">
              <%= faculty.deanName ? 'Dean Assigned' : 'No Dean' %>
            </div>
          </div>

          <div class="faculty-actions">
            <button
              class="action-btn edit-btn"
              onclick="editFaculty('<%= index %>')"
            >
              Edit Faculty
            </button>
            <button
              class="action-btn assign-dean-btn"
              onclick="assignDean('<%= index %>')"
            >
              <%= faculty.deanName ? 'Change Dean' : 'Assign Dean' %>
            </button>
            <button
              class="action-btn view-btn"
              onclick="viewFacultyCourses('<%= index %>')"
            >
              View Courses (<%= faculty.courses ? faculty.courses.length : 0 %>)
            </button>
            <button
              class="action-btn delete-btn"
              onclick="deleteFaculty('<%= index %>')"
            >
              Delete
            </button>
          </div>
        </div>
        <% }) %>
      </div>
      <% } else { %>
      <div class="no-faculties">
        <h3>No Faculties Found</h3>
        <p>This university doesn't have any faculties yet.</p>
        <a href="/universities/<%= university._id %>" class="btn btn-primary">
          ← Go Back to Create a Faculty
        </a>
      </div>
      <% } %>

      <!-- Create New Faculty Button -->
      <div style="text-align: center; margin-top: 2rem">
        <button class="btn btn-primary" onclick="createNewFaculty()">
          + Create New Faculty
        </button>
      </div>
    </div>

    <!-- Edit Faculty Modal -->
    <div id="editFacultyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Faculty</h3>
          <span class="close" onclick="closeEditFacultyModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editFacultyForm">
            <input type="hidden" id="editFacultyIndex" name="facultyIndex" />

            <div class="form-group">
              <label for="editFacultyName">Faculty Name *</label>
              <input
                type="text"
                id="editFacultyName"
                name="name"
                required
                maxlength="100"
                placeholder="Enter faculty name"
              />
              <div class="char-count" id="editFacultyNameCount">
                0/100 characters
              </div>
            </div>

            <div class="form-group">
              <label for="editFacultyDescription">Description</label>
              <textarea
                id="editFacultyDescription"
                name="description"
                rows="4"
                maxlength="500"
                placeholder="Enter faculty description"
              ></textarea>
              <div class="char-count" id="editFacultyDescriptionCount">
                0/500 characters
              </div>
            </div>

            <div class="form-group">
              <label for="editFacultyContactEmail">Contact Email</label>
              <input
                type="email"
                id="editFacultyContactEmail"
                name="contactEmail"
                maxlength="100"
                placeholder="Enter contact email"
              />
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-outline"
                onclick="closeEditFacultyModal()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Assign Dean Modal -->
    <div id="assignDeanModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="assignDeanTitle">Assign Dean</h3>
          <span class="close" onclick="closeAssignDeanModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div id="assignDeanLoading" class="loading">
            <div class="loading-spinner"></div>
            <p>Loading available deans...</p>
          </div>

          <form id="assignDeanForm" style="display: none">
            <input type="hidden" id="assignFacultyIndex" name="facultyIndex" />

            <div class="form-group">
              <label for="deanSelect">Select Dean</label>
              <select id="deanSelect" name="deanId" class="form-control">
                <option value="">-- No Dean --</option>
                <!-- Options will be populated dynamically -->
              </select>
              <small style="color: #666; margin-top: 0.5rem; display: block">
                Select a university member to assign as dean. Leave empty to
                remove current dean.
              </small>
            </div>

            <div
              id="currentDeanInfo"
              style="
                background: #f0f7ff;
                padding: 1rem;
                border-radius: 4px;
                margin-bottom: 1.5rem;
                display: none;
              "
            >
              <h4 style="margin: 0 0 0.5rem 0; color: #333">Current Dean</h4>
              <p id="currentDeanName" style="margin: 0; font-weight: 500"></p>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-outline"
                onclick="closeAssignDeanModal()"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Assign Dean</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteFacultyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Delete Faculty</h3>
          <span class="close" onclick="closeDeleteFacultyModal()">&times;</span>
        </div>
        <div class="modal-body">
          <p id="deleteFacultyMessage">
            Are you sure you want to delete this faculty?
          </p>
          <p style="color: #e74c3c; font-weight: bold">
            Warning: This will also delete all courses under this faculty!
          </p>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-outline"
              onclick="closeDeleteFacultyModal()"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDeleteFaculty()"
            >
              Delete Faculty
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Define university data from EJS
      const universityData = {
        _id: "<%= university._id %>",
        name: "<%= university.name %>",
        faculties: "<%= JSON.stringify(university.faculties || []) %>",
      };

      // Global variables
      let currentFacultyIndex = null;
      let availableDeans = [];

      // Edit Faculty
      function editFaculty(facultyIndex) {
        const faculty = universityData.faculties[facultyIndex];
        if (!faculty) return;

        currentFacultyIndex = facultyIndex;

        // Populate form
        document.getElementById("editFacultyIndex").value = facultyIndex;
        document.getElementById("editFacultyName").value = faculty.name || "";
        document.getElementById("editFacultyDescription").value =
          faculty.description || "";
        document.getElementById("editFacultyContactEmail").value =
          faculty.contactEmail || "";

        // Update character counts
        updateCharCount("editFacultyName", "editFacultyNameCount", 100);
        updateCharCount(
          "editFacultyDescription",
          "editFacultyDescriptionCount",
          500
        );

        // Show modal
        document.getElementById("editFacultyModal").style.display = "flex";
      }

      // Close Edit Modal
      function closeEditFacultyModal() {
        document.getElementById("editFacultyModal").style.display = "none";
        currentFacultyIndex = null;
      }

      // Assign Dean
      async function assignDean(facultyIndex) {
        const faculty = universityData.faculties[facultyIndex];
        if (!faculty) return;

        currentFacultyIndex = facultyIndex;

        // Show modal with loading state
        document.getElementById("assignDeanModal").style.display = "flex";
        document.getElementById("assignDeanLoading").style.display = "block";
        document.getElementById("assignDeanForm").style.display = "none";

        // Update title
        document.getElementById(
          "assignDeanTitle"
        ).textContent = `Assign Dean - ${faculty.name}`;

        document.getElementById("assignFacultyIndex").value = facultyIndex;

        try {
          // Fetch available deans
          const response = await fetch(
            `/universities/${universityData._id}/faculties/${facultyIndex}/available-deans`
          );

          if (!response.ok) {
            throw new Error("Failed to fetch available deans");
          }

          const data = await response.json();
          availableDeans = data.availableDeans;

          // Populate dean select dropdown
          const deanSelect = document.getElementById("deanSelect");
          deanSelect.innerHTML = '<option value="">-- No Dean --</option>';

          availableDeans.forEach((dean) => {
            const option = document.createElement("option");
            option.value = dean._id;
            option.textContent = `${dean.name} (${dean.role})`;

            // Mark as selected if this is the current dean
            if (dean._id === data.currentDean) {
              option.selected = true;
            }

            deanSelect.appendChild(option);
          });

          // Show current dean info if exists
          if (data.currentDeanName) {
            document.getElementById("currentDeanInfo").style.display = "block";
            document.getElementById("currentDeanName").textContent =
              data.currentDeanName;
          } else {
            document.getElementById("currentDeanInfo").style.display = "none";
          }

          // Hide loading, show form
          document.getElementById("assignDeanLoading").style.display = "none";
          document.getElementById("assignDeanForm").style.display = "block";
        } catch (error) {
          console.error("Error fetching deans:", error);
          alert("Error loading available deans. Please try again.");
          closeAssignDeanModal();
        }
      }

      // Close Assign Dean Modal
      function closeAssignDeanModal() {
        document.getElementById("assignDeanModal").style.display = "none";
        currentFacultyIndex = null;
        availableDeans = [];
      }

      // Delete Faculty
      function deleteFaculty(facultyIndex) {
        const faculty = universityData.faculties[facultyIndex];
        if (!faculty) return;

        currentFacultyIndex = facultyIndex;

        // Set confirmation message
        const message = `Are you sure you want to delete the faculty "${faculty.name}"?`;
        document.getElementById("deleteFacultyMessage").textContent = message;

        // Show modal
        document.getElementById("deleteFacultyModal").style.display = "flex";
      }

      // Close Delete Modal
      function closeDeleteFacultyModal() {
        document.getElementById("deleteFacultyModal").style.display = "none";
        currentFacultyIndex = null;
      }

      // Confirm Delete
      async function confirmDeleteFaculty() {
        if (currentFacultyIndex === null) return;

        const faculty = universityData.faculties[currentFacultyIndex];
        if (!faculty) return;

        try {
          const response = await fetch(
            `/universities/${universityData._id}/faculties/${currentFacultyIndex}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const result = await response.json();

          if (response.ok) {
            alert("Faculty deleted successfully!");
            closeDeleteFacultyModal();
            window.location.reload();
          } else {
            alert(result.error || "Failed to delete faculty");
          }
        } catch (error) {
          console.error("Error deleting faculty:", error);
          alert("Error deleting faculty. Please try again.");
        }
      }

      // Create New Faculty
      function createNewFaculty() {
        window.location.href = `/universities/${universityData._id}`;
      }

      // View Faculty Courses
      function viewFacultyCourses(facultyIndex) {
        window.location.href = `/universities/${
          universityData._id
        }/faculties/${facultyIndex}/courses?name=${encodeURIComponent(
          universityData.faculties[facultyIndex].name
        )}`;
      }

      // Handle Assign Dean Form Submission
      document
        .getElementById("assignDeanForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const facultyIndex = formData.get("facultyIndex");
          const deanId = formData.get("deanId");

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;

          try {
            submitBtn.textContent = "Assigning...";
            submitBtn.disabled = true;

            const response = await fetch(
              `/universities/${universityData._id}/faculties/${facultyIndex}/assign-dean`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ deanId: deanId }),
              }
            );

            const result = await response.json();

            if (response.ok) {
              alert(result.message || "Dean assigned successfully!");
              closeAssignDeanModal();
              window.location.reload();
            } else {
              alert(result.error || "Failed to assign dean");
            }
          } catch (error) {
            console.error("Error assigning dean:", error);
            alert("Error assigning dean. Please try again.");
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      // Handle Edit Form Submission
      document
        .getElementById("editFacultyForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const facultyIndex = formData.get("facultyIndex");
          const facultyData = {
            name: formData.get("name"),
            description: formData.get("description"),
            contactEmail: formData.get("contactEmail"),
          };

          // Validate
          if (!facultyData.name.trim()) {
            alert("Faculty name is required");
            return;
          }

          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;

          try {
            submitBtn.textContent = "Saving...";
            submitBtn.disabled = true;

            const response = await fetch(
              `/universities/${universityData._id}/faculties/${facultyIndex}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(facultyData),
              }
            );

            const result = await response.json();

            if (response.ok) {
              alert("Faculty updated successfully!");
              closeEditFacultyModal();
              window.location.reload();
            } else {
              alert(result.error || "Failed to update faculty");
            }
          } catch (error) {
            console.error("Error updating faculty:", error);
            alert("Error updating faculty. Please try again.");
          } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

      // Character count helpers
      function updateCharCount(inputId, countId, maxLength) {
        const input = document.getElementById(inputId);
        const count = document.getElementById(countId);

        if (input && count) {
          const length = input.value.length;
          count.textContent = `${length}/${maxLength} characters`;
          count.style.color = length > maxLength ? "#e74c3c" : "#666";
        }
      }

      // Add character count listeners
      document.addEventListener("DOMContentLoaded", function () {
        const nameInput = document.getElementById("editFacultyName");
        const descInput = document.getElementById("editFacultyDescription");

        if (nameInput) {
          nameInput.addEventListener("input", function () {
            updateCharCount("editFacultyName", "editFacultyNameCount", 100);
          });
        }

        if (descInput) {
          descInput.addEventListener("input", function () {
            updateCharCount(
              "editFacultyDescription",
              "editFacultyDescriptionCount",
              500
            );
          });
        }

        // Close modals when clicking outside
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => {
          modal.addEventListener("click", function (e) {
            if (e.target === this) {
              if (this.id === "editFacultyModal") {
                closeEditFacultyModal();
              } else if (this.id === "assignDeanModal") {
                closeAssignDeanModal();
              } else if (this.id === "deleteFacultyModal") {
                closeDeleteFacultyModal();
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
