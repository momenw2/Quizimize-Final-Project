<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <style>
      /* Course Management Styles */
      .manage-courses-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
      }

      .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .course-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .course-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .course-code {
        font-size: 1.1rem;
        font-weight: bold;
        color: #4a90e2;
        background: #f0f7ff;
        padding: 5px 10px;
        border-radius: 5px;
      }

      .course-faculty {
        font-size: 0.9rem;
        color: #666;
        background: #f5f5f5;
        padding: 3px 8px;
        border-radius: 4px;
      }

      .course-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 10px 0;
        color: #333;
      }

      .course-description {
        color: #666;
        margin-bottom: 15px;
        line-height: 1.5;
      }

      .course-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .stat-item {
        text-align: center;
        flex: 1;
      }

      .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #4a90e2;
      }

      .stat-label {
        font-size: 0.8rem;
        color: #666;
        margin-top: 5px;
      }

      .course-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f8f9fa;
        border-radius: 10px 10px 0 0;
      }

      .modal-title {
        margin: 0;
        color: #333;
        font-size: 1.5rem;
      }

      .close-modal {
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }

      .close-modal:hover {
        background: #eee;
        color: #333;
      }

      .modal-body {
        padding: 20px;
      }

      /* Tabs in Modal */
      .management-tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
      }

      .tab-btn {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn:hover {
        color: #4a90e2;
      }

      .tab-btn.active {
        color: #4a90e2;
        border-bottom-color: #4a90e2;
        font-weight: 600;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      }

      .select-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      /* Table Styles */
      .members-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .members-table th,
      .members-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      .members-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
      }

      .members-table tr:hover {
        background: #f9f9f9;
      }

      .role-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .role-admin {
        background: #4a90e2;
        color: white;
      }

      .role-teacher {
        background: #17a2b8;
        color: white;
      }

      .role-student {
        background: #28a745;
        color: white;
      }

      .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.3s;
      }

      .btn-assign {
        background: #4a90e2;
        color: white;
      }

      .btn-assign:hover {
        background: #357abd;
      }

      .btn-enroll {
        background: #28a745;
        color: white;
      }

      .btn-enroll:hover {
        background: #218838;
      }

      .btn-remove {
        background: #dc3545;
        color: white;
      }

      .btn-remove:hover {
        background: #c82333;
      }

      /* Classroom Management */
      .classrooms-list {
        margin-top: 20px;
      }

      .classroom-card {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .classroom-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .classroom-name {
        font-weight: 600;
        color: #333;
      }

      .classroom-meta {
        display: flex;
        gap: 15px;
        color: #666;
        font-size: 0.9rem;
      }

      .classroom-students {
        margin-top: 10px;
      }

      .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }

      .student-item:last-child {
        border-bottom: none;
      }

      .student-status {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 3px;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .status-suspended {
        background: #fff3cd;
        color: #856404;
      }

      /* Button Styles */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #4a90e2;
        color: white;
      }

      .btn-primary:hover {
        background: #357abd;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-outline {
        background: transparent;
        color: #4a90e2;
        border: 2px solid #4a90e2;
      }

      .btn-outline:hover {
        background: #4a90e2;
        color: white;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 0.9rem;
      }

      /* Loading State */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4a90e2;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state i {
        font-size: 3rem;
        color: #ddd;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="manage-courses-container">
      <div class="header-actions">
        <h1>Manage Courses - <%= university.name %></h1>
        <a href="/universities/<%= university._id %>" class="btn btn-outline">
          ‚Üê Back to Dashboard
        </a>
      </div>

      <div class="courses-grid" id="coursesGrid">
        <% if (courses.length === 0) { %>
        <div class="empty-state">
          <i>üìö</i>
          <h3>No Courses Available</h3>
          <p>Create your first course to get started with course management.</p>
          <a href="/universities/<%= university._id %>" class="btn btn-primary">
            Create Course
          </a>
        </div>
        <% } else { %> <% courses.forEach(course => { %>
        <div
          class="course-card"
          data-course-id="<%= course.facultyIndex %>-<%= course.courseIndex %>"
        >
          <div class="course-header">
            <span class="course-code"><%= course.courseCode %></span>
            <span class="course-faculty"><%= course.facultyName %></span>
          </div>

          <h3 class="course-title"><%= course.courseName %></h3>

          <% if (course.description) { %>
          <p class="course-description"><%= course.description %></p>
          <% } %>

          <div class="course-stats">
            <div class="stat-item">
              <div class="stat-value"><%= course.totalStudents %></div>
              <div class="stat-label">Students</div>
            </div>
            <div class="stat-item">
              <div class="stat-value"><%= course.classrooms.length %></div>
              <div class="stat-label">Classrooms</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">Lv. <%= course.level %></div>
              <div class="stat-label">Level</div>
            </div>
          </div>

          <div class="course-actions">
            <button
              class="btn btn-primary btn-sm"
              onclick="manageCourse('<%= course.facultyIndex %>', '<%= course.courseIndex %>', '<%= course.courseCode %> - <%= course.courseName %>')"
            >
              Manage Course
            </button>
            <button
              class="btn btn-secondary btn-sm"
              onclick="viewCourse('<%= course.facultyIndex %>', '<%= course.courseIndex %>')"
            >
              View Details
            </button>
          </div>
        </div>
        <% }); %> <% } %>
      </div>
    </div>

    <!-- Course Management Modal -->
    <div id="courseManagementModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Manage Course</h2>
          <button class="close-modal" onclick="closeCourseModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="management-tabs">
            <button class="tab-btn active" data-tab="teacher">
              Assign Teacher
            </button>
            <button class="tab-btn" data-tab="classrooms">Classrooms</button>
            <button class="tab-btn" data-tab="students">Manage Students</button>
          </div>

          <div id="teacherTab" class="tab-content active">
            <div class="loading" id="teacherLoading">
              <div class="spinner"></div>
              <span>Loading teacher information...</span>
            </div>
            <div id="teacherContent" style="display: none">
              <div class="form-group">
                <label class="form-label" for="teacherSelect"
                  >Current Teacher</label
                >
                <select class="select-control" id="teacherSelect">
                  <option value="">Loading teachers...</option>
                </select>
              </div>
              <button
                class="btn btn-primary"
                onclick="assignTeacher()"
                id="assignTeacherBtn"
              >
                Assign Teacher
              </button>
            </div>
          </div>

          <div id="classroomsTab" class="tab-content">
            <div class="loading" id="classroomsLoading">
              <div class="spinner"></div>
              <span>Loading classrooms...</span>
            </div>
            <div id="classroomsContent" style="display: none">
              <div class="form-group">
                <h4>Create New Classroom</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="classroomName"
                      >Classroom Name *</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="classroomName"
                      placeholder="e.g., Section A, Morning Class"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="classroomSection"
                      >Section</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="classroomSection"
                      placeholder="e.g., 2024-2025"
                    />
                  </div>
                </div>
                <button class="btn btn-success" onclick="createClassroom()">
                  Create Classroom
                </button>
              </div>

              <div class="classrooms-list" id="classroomsList">
                <!-- Classrooms will be loaded here -->
              </div>
            </div>
          </div>

          <div id="studentsTab" class="tab-content">
            <div class="loading" id="studentsLoading">
              <div class="spinner"></div>
              <span>Loading students...</span>
            </div>
            <div id="studentsContent" style="display: none">
              <div class="form-group">
                <h4>University Members</h4>
                <table class="members-table" id="universityMembersTable">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Role</th>
                      <th>Level</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="membersTableBody">
                    <!-- Members will be loaded here -->
                  </tbody>
                </table>
              </div>

              <div class="form-group">
                <h4>Enrolled Students</h4>
                <table class="members-table" id="enrolledStudentsTable">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Classroom</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="enrolledTableBody">
                    <!-- Enrolled students will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentFacultyIndex = null;
      let currentCourseIndex = null;
      let currentCourseCode = null;
      let universityMembers = [];
      let courseParticipants = [];

      // Manage Course Function
      function manageCourse(facultyIndex, courseIndex, courseName) {
        currentFacultyIndex = facultyIndex;
        currentCourseIndex = courseIndex;
        currentCourseCode = courseName;

        document.getElementById(
          "modalTitle"
        ).textContent = `Manage: ${courseName}`;
        document.getElementById("courseManagementModal").style.display = "flex";

        // Reset tabs
        switchTab("teacher");
        loadCourseManagementData();
      }

      // View Course Details
      function viewCourse(facultyIndex, courseIndex) {
        window.location.href = `/universities/<%= university._id %>/faculties/${facultyIndex}/courses/${courseIndex}`;
      }

      // Close Modal
      function closeCourseModal() {
        document.getElementById("courseManagementModal").style.display = "none";
        resetModal();
      }

      // Reset Modal State
      function resetModal() {
        currentFacultyIndex = null;
        currentCourseIndex = null;
        currentCourseCode = null;
        universityMembers = [];
        courseParticipants = [];

        // Hide all content areas
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.style.display = "none";
          tab.classList.remove("active");
        });

        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
      }

      // Switch Tabs
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.dataset.tab === tabName) {
            btn.classList.add("active");
          }
        });

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.style.display = "none";
          tab.classList.remove("active");
          if (tab.id === tabName + "Tab") {
            tab.style.display = "block";
            tab.classList.add("active");
          }
        });

        // Load data for the tab if needed
        if (tabName === "teacher") {
          loadTeacherData();
        } else if (tabName === "classrooms") {
          loadClassroomsData();
        } else if (tabName === "students") {
          loadStudentsData();
        }
      }

      // Load Course Management Data
      async function loadCourseManagementData() {
        try {
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/manage`
          );
          const data = await response.json();

          if (response.ok) {
            universityMembers = data.universityMembers;
            courseParticipants = data.courseParticipants;

            // Switch to teacher tab and load data
            switchTab("teacher");
          } else {
            alert(data.error || "Failed to load course data");
          }
        } catch (error) {
          console.error("Error loading course data:", error);
          alert("Error loading course data. Please try again.");
        }
      }

      // Load Teacher Data
      async function loadTeacherData() {
        const loading = document.getElementById("teacherLoading");
        const content = document.getElementById("teacherContent");

        try {
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/manage`
          );
          const data = await response.json();

          if (response.ok) {
            // Populate teacher select
            const teacherSelect = document.getElementById("teacherSelect");
            teacherSelect.innerHTML =
              '<option value="">Select a teacher</option>';

            // Filter members who are teachers
            const teachers = data.universityMembers.filter(
              (member) => member.role === "teacher" || member.role === "admin"
            );

            teachers.forEach((teacher) => {
              const option = document.createElement("option");
              option.value = teacher.userId;
              option.textContent = `Teacher ID: ${teacher.userId} (Level ${teacher.level})`;
              // Select current teacher if exists
              if (data.course.teacher === teacher.userId) {
                option.selected = true;
              }
              teacherSelect.appendChild(option);
            });

            loading.style.display = "none";
            content.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading teacher data:", error);
          loading.innerHTML =
            '<span style="color: #dc3545;">Error loading teacher data</span>';
        }
      }

      // Assign Teacher
      async function assignTeacher() {
        const teacherSelect = document.getElementById("teacherSelect");
        const teacherId = teacherSelect.value;
        const assignBtn = document.getElementById("assignTeacherBtn");

        if (!teacherId) {
          alert("Please select a teacher");
          return;
        }

        assignBtn.disabled = true;
        assignBtn.textContent = "Assigning...";

        try {
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/assign-teacher`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ teacherId }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert(data.message);
            // Refresh the teacher data
            loadTeacherData();
          } else {
            alert(data.error || "Failed to assign teacher");
          }
        } catch (error) {
          console.error("Error assigning teacher:", error);
          alert("Error assigning teacher. Please try again.");
        } finally {
          assignBtn.disabled = false;
          assignBtn.textContent = "Assign Teacher";
        }
      }

      // Load Classrooms Data
      async function loadClassroomsData() {
        const loading = document.getElementById("classroomsLoading");
        const content = document.getElementById("classroomsContent");
        const classroomsList = document.getElementById("classroomsList");

        try {
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/manage`
          );
          const data = await response.json();

          if (response.ok) {
            const classrooms = data.course.classrooms || [];

            if (classrooms.length === 0) {
              classroomsList.innerHTML = `
                            <div class="empty-state">
                                <i>üè´</i>
                                <p>No classrooms created yet. Create your first classroom.</p>
                            </div>
                        `;
            } else {
              classroomsList.innerHTML = classrooms
                .map(
                  (classroom, index) => `
                            <div class="classroom-card">
                                <div class="classroom-header">
                                    <div>
                                        <div class="classroom-name">${
                                          classroom.name
                                        }</div>
                                        <div class="classroom-meta">
                                            <span>Section: ${
                                              classroom.section || "N/A"
                                            }</span>
                                            <span>Students: ${
                                              classroom.students
                                                ? classroom.students.length
                                                : 0
                                            }</span>
                                            <span>Level: ${
                                              classroom.level
                                            }</span>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-secondary" onclick="manageClassroomStudents(${index})">
                                            Manage Students
                                        </button>
                                    </div>
                                </div>
                                
                                ${
                                  classroom.students &&
                                  classroom.students.length > 0
                                    ? `
                                    <div class="classroom-students">
                                        <h5>Students in this classroom:</h5>
                                        ${classroom.students
                                          .slice(0, 3)
                                          .map(
                                            (student) => `
                                            <div class="student-item">
                                                <span>Student ID: ${student.student}</span>
                                                <span class="student-status status-${student.status}">
                                                    ${student.status}
                                                </span>
                                            </div>
                                        `
                                          )
                                          .join("")}
                                        ${
                                          classroom.students.length > 3
                                            ? `
                                            <div class="student-item">
                                                <span>... and ${
                                                  classroom.students.length - 3
                                                } more students</span>
                                            </div>
                                        `
                                            : ""
                                        }
                                    </div>
                                `
                                    : `
                                    <div class="empty-state">
                                        <p>No students enrolled in this classroom yet.</p>
                                    </div>
                                `
                                }
                            </div>
                        `
                )
                .join("");
            }

            loading.style.display = "none";
            content.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading classrooms:", error);
          loading.innerHTML =
            '<span style="color: #dc3545;">Error loading classrooms</span>';
        }
      }

      // Create Classroom
      async function createClassroom() {
        const nameInput = document.getElementById("classroomName");
        const sectionInput = document.getElementById("classroomSection");

        if (!nameInput.value.trim()) {
          alert("Please enter a classroom name");
          nameInput.focus();
          return;
        }

        try {
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/create-classroom`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: nameInput.value.trim(),
                section: sectionInput.value.trim(),
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert(data.message);
            // Clear form
            nameInput.value = "";
            sectionInput.value = "";
            // Refresh classrooms list
            loadClassroomsData();
          } else {
            alert(data.error || "Failed to create classroom");
          }
        } catch (error) {
          console.error("Error creating classroom:", error);
          alert("Error creating classroom. Please try again.");
        }
      }

      // Load Students Data
      async function loadStudentsData() {
        const loading = document.getElementById("studentsLoading");
        const content = document.getElementById("studentsContent");

        try {
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/manage`
          );
          const data = await response.json();

          if (response.ok) {
            // Populate university members table
            const membersTableBody =
              document.getElementById("membersTableBody");
            membersTableBody.innerHTML = "";

            data.universityMembers.forEach((member) => {
              const row = document.createElement("tr");

              // Check if student is already enrolled
              const isEnrolled = data.courseParticipants.some(
                (participant) => participant.userId === member.userId
              );

              row.innerHTML = `
                            <td>User ID: ${member.userId}</td>
                            <td>
                                <span class="role-badge role-${member.role}">
                                    ${member.role}
                                </span>
                            </td>
                            <td>${member.level}</td>
                            <td>
                                ${
                                  !isEnrolled && member.role === "student"
                                    ? `
                                    <button class="action-btn btn-enroll" 
                                            onclick="enrollStudent('${member.userId}')">
                                        Enroll
                                    </button>
                                `
                                    : isEnrolled
                                    ? `
                                    <span style="color: #28a745;">Already Enrolled</span>
                                `
                                    : `
                                    <span style="color: #666;">Not a student</span>
                                `
                                }
                            </td>
                        `;

              membersTableBody.appendChild(row);
            });

            // Populate enrolled students table
            const enrolledTableBody =
              document.getElementById("enrolledTableBody");
            enrolledTableBody.innerHTML = "";

            if (data.courseParticipants.length === 0) {
              enrolledTableBody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; color: #666;">
                                    No students enrolled in this course yet.
                                </td>
                            </tr>
                        `;
            } else {
              data.courseParticipants.forEach((participant) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                                <td>${participant.userId}</td>
                                <td>${participant.classroom}</td>
                                <td>
                                    <span class="student-status status-${participant.status}">
                                        ${participant.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="action-btn btn-remove" 
                                            onclick="unenrollStudent('${participant.userId}')">
                                        Remove
                                    </button>
                                </td>
                            `;
                enrolledTableBody.appendChild(row);
              });
            }

            loading.style.display = "none";
            content.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading students data:", error);
          loading.innerHTML =
            '<span style="color: #dc3545;">Error loading students data</span>';
        }
      }

      // Enroll Student
      async function enrollStudent(studentId) {
        if (!confirm(`Enroll student ${studentId} in this course?`)) {
          return;
        }

        try {
          // First, we need to know which classroom to add to
          // For simplicity, let's add to the first classroom
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/manage`
          );
          const data = await response.json();

          if (data.course.classrooms.length === 0) {
            alert("Please create a classroom first before enrolling students.");
            switchTab("classrooms");
            return;
          }

          // Add to first classroom
          const classroomResponse = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/classrooms/0/manage-students`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "add",
                studentId: studentId,
              }),
            }
          );

          const result = await classroomResponse.json();

          if (classroomResponse.ok) {
            alert("Student enrolled successfully!");
            loadStudentsData(); // Refresh the students tab
          } else {
            alert(result.error || "Failed to enroll student");
          }
        } catch (error) {
          console.error("Error enrolling student:", error);
          alert("Error enrolling student. Please try again.");
        }
      }

      // Unenroll Student
      async function unenrollStudent(studentId) {
        if (!confirm(`Remove student ${studentId} from this course?`)) {
          return;
        }

        try {
          // We need to find which classroom the student is in
          const response = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/manage`
          );
          const data = await response.json();

          // Find the classroom where the student is enrolled
          let classroomIndex = null;
          data.course.classrooms.forEach((classroom, index) => {
            if (classroom.students) {
              const studentExists = classroom.students.some(
                (student) => student.student.toString() === studentId.toString()
              );
              if (studentExists) {
                classroomIndex = index;
              }
            }
          });

          if (classroomIndex === null) {
            alert("Student not found in any classroom");
            return;
          }

          const removeResponse = await fetch(
            `/universities/<%= university._id %>/faculties/${currentFacultyIndex}/courses/${currentCourseIndex}/classrooms/${classroomIndex}/manage-students`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "remove",
                studentId: studentId,
              }),
            }
          );

          const result = await removeResponse.json();

          if (removeResponse.ok) {
            alert("Student removed successfully!");
            loadStudentsData(); // Refresh the students tab
          } else {
            alert(result.error || "Failed to remove student");
          }
        } catch (error) {
          console.error("Error removing student:", error);
          alert("Error removing student. Please try again.");
        }
      }

      // Manage Classroom Students (simplified version)
      function manageClassroomStudents(classroomIndex) {
        alert(
          `Managing students for classroom ${
            classroomIndex + 1
          }. You can enroll students from the "Manage Students" tab.`
        );
        switchTab("students");
      }

      // Tab click event listeners
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const tabName = this.dataset.tab;
            switchTab(tabName);
          });
        });

        // Close modal when clicking outside
        document
          .getElementById("courseManagementModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeCourseModal();
            }
          });
      });
    </script>
  </body>
</html>
