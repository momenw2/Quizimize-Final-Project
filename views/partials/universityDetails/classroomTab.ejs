<div class="tab-content" id="classroom">
  <div class="classroom-management">
    <!-- Add Classroom Button (Dean Only) -->
    <% if (canManageClassroom) { %>
    <div style="margin-bottom: 1.5rem">
      <button
        id="add-classroom-btn"
        style="
          padding: 0.75rem 1.5rem;
          background-color: #4a90e2;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 1rem;
        "
      >
        üè´ Add New Classroom
      </button>
    </div>
    <% } %>

    <!-- Classrooms List -->
    <% if (course.classrooms && course.classrooms.length > 0) { %>
    <div class="classrooms-grid" id="classrooms-grid">
      <% course.classrooms.forEach((classroom, index) => { %>
      <div class="classroom-card" data-classroom-index="<%= index %>">
        <div class="classroom-header">
          <div class="classroom-name">
            <strong><%= classroom.name %></strong>
          </div>
          <% if (classroom.section) { %>
          <span class="classroom-section"
            >Section <%= classroom.section %></span
          >
          <% } %>
        </div>

        <% if (classroom.schedule) { %>
        <div class="classroom-schedule">
          <div class="schedule-item">
            <span class="schedule-label">üìÖ Day:</span>
            <span class="schedule-value"><%= classroom.schedule.day %></span>
          </div>
          <div class="schedule-item">
            <span class="schedule-label">‚è∞ Time:</span>
            <span class="schedule-value"><%= classroom.schedule.time %></span>
          </div>
          <% if (classroom.schedule.location) { %>
          <div class="schedule-item">
            <span class="schedule-label">üìç Location:</span>
            <span class="schedule-value"
              ><%= classroom.schedule.location %></span
            >
          </div>
          <% } %>
        </div>
        <% } %>

        <div class="classroom-stats">
          <div class="stat-item">
            <span class="stat-label">Students:</span>
            <span class="stat-value">
              <%= classroom.students ? classroom.students.length : 0 %>
            </span>
          </div>
          <% if (classroom.xp && classroom.xp > 0) { %>
          <div class="stat-item">
            <span class="stat-label">XP:</span>
            <span class="stat-value"><%= classroom.xp %></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Level:</span>
            <span class="stat-value"><%= classroom.level || 1 %></span>
          </div>
          <% } %>
        </div>

        <div class="classroom-actions">
          <button
            class="classroom-action-btn join-btn"
            data-classroom-index="<%= index %>"
          >
            üöÄ Join Classroom
          </button>
          <% if (canManageClassroom) { %>
          <button
            class="classroom-action-btn manage-btn"
            data-classroom-index="<%= index %>"
          >
            ‚öôÔ∏è Manage
          </button>
          <% } %>
        </div>
      </div>
      <% }) %>
    </div>
    <% } else { %>
    <div class="no-classrooms">
      <div class="no-classrooms-icon">üè´</div>
      <h3>No Classrooms Available</h3>
      <p>This course doesn't have any classrooms yet.</p>
      <% if (canManageClassroom) { %>
      <p>
        Click "Add New Classroom" to create the first classroom for this course.
      </p>
      <% } %>
    </div>
    <% } %>
  </div>
</div>

<script>
  // Check if ClassroomTab is already defined to avoid redefinition
  if (typeof window.ClassroomTab === "undefined") {
    class ClassroomTab {
      constructor(courseData) {
        this.courseData = courseData;
        this.init();
      }

      init() {
        this.bindEvents();
      }

      bindEvents() {
        // Add Classroom Button - use event delegation
        document.addEventListener("click", (e) => {
          // Handle Add Classroom button
          if (
            e.target.id === "add-classroom-btn" ||
            e.target.closest("#add-classroom-btn")
          ) {
            this.showAddClassroomModal();
          }

          // Handle Join Classroom buttons
          if (
            e.target.classList.contains("join-btn") ||
            e.target.closest(".join-btn")
          ) {
            const button = e.target.classList.contains("join-btn")
              ? e.target
              : e.target.closest(".join-btn");
            const classroomIndex = button.dataset.classroomIndex;
            this.enrollInClassroom(classroomIndex);
          }

          // Handle Manage Classroom buttons
          if (
            e.target.classList.contains("manage-btn") ||
            e.target.closest(".manage-btn")
          ) {
            const button = e.target.classList.contains("manage-btn")
              ? e.target
              : e.target.closest(".manage-btn");
            const classroomIndex = button.dataset.classroomIndex;
            this.manageClassroom(classroomIndex);
          }
        });
      }

      showAddClassroomModal() {
        const modalHtml = `
          <div class="modal-overlay" id="add-classroom-modal">
            <div class="modal-content">
              <h2 style="margin-bottom: 1rem">üè´ Add New Classroom</h2>
              
              <form id="create-classroom-form">
                <div style="margin-bottom: 1rem">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600">
                    Classroom Name *
                  </label>
                  <input 
                    type="text" 
                    id="classroom-name" 
                    placeholder="e.g., Morning Session, Group A, etc."
                    style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px;"
                    required
                  />
                </div>

                <div style="margin-bottom: 1rem">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600">
                    Section (Optional)
                  </label>
                  <input 
                    type="text" 
                    id="classroom-section" 
                    placeholder="e.g., A, B, C or 1, 2, 3"
                    style="width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px;"
                  />
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end">
                  <button 
                    type="button" 
                    id="cancel-classroom-modal"
                    style="padding: 0.75rem 1.5rem; background-color: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer;"
                  >
                    Cancel
                  </button>
                  <button 
                    type="submit"
                    style="padding: 0.75rem 1.5rem; background-color: #4a90e2; color: white; border: none; border-radius: 6px; cursor: pointer;"
                  >
                    Create Classroom
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;

        const modalContainer = document.createElement("div");
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        const form = document.getElementById("create-classroom-form");
        const cancelBtn = document.getElementById("cancel-classroom-modal");
        const modal = document.getElementById("add-classroom-modal");

        form.addEventListener("submit", (e) => this.createClassroom(e));
        cancelBtn.addEventListener("click", () => this.closeModal());

        // Close modal when clicking outside
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            this.closeModal();
          }
        });
      }

      closeModal() {
        const modal = document.getElementById("add-classroom-modal");
        if (modal) {
          modal.remove();
        }
      }

      async createClassroom(e) {
        e.preventDefault();

        const name = document.getElementById("classroom-name").value.trim();
        const section = document
          .getElementById("classroom-section")
          .value.trim();

        if (!name) {
          alert("Please enter a classroom name");
          return;
        }

        try {
          const response = await fetch(
            `/universities/${this.courseData.universityId}/faculties/${this.courseData.facultyIndex}/courses/${this.courseData.courseIndex}/create-classroom`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name,
                section: section || "",
                schedule: {},
              }),
            }
          );

          const result = await response.json();

          if (response.ok) {
            alert(result.message || "Classroom created successfully!");
            this.closeModal();
            location.reload();
          } else {
            alert(result.error || "Failed to create classroom");
          }
        } catch (error) {
          console.error("Error creating classroom:", error);
          alert("Failed to create classroom. Please try again.");
        }
      }

      async enrollInClassroom(classroomIndex) {
        if (!this.courseData.isMember) {
          alert(
            `You must be a member of ${this.courseData.universityName} to join a classroom.`
          );
          return;
        }

        const confirmation = confirm("Join this classroom?");
        if (!confirmation) return;

        try {
          const response = await fetch(
            `/universities/${this.courseData.universityId}/faculties/${this.courseData.facultyIndex}/courses/${this.courseData.courseIndex}/enroll`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                classroomIndex: parseInt(classroomIndex),
              }),
            }
          );

          const result = await response.json();

          if (response.ok) {
            alert(result.message || "Successfully joined classroom!");
            location.reload();
          } else {
            alert(result.error || "Failed to join classroom");
          }
        } catch (error) {
          console.error("Error joining classroom:", error);
          alert("Failed to join classroom. Please try again.");
        }
      }

      manageClassroom(classroomIndex) {
        alert(
          `Manage classroom ${classroomIndex} - This feature is under development`
        );
      }
    }

    // Store it globally
    window.ClassroomTab = ClassroomTab;
  }

  // Initialize when the DOM is ready
  document.addEventListener("DOMContentLoaded", function () {
    if (window.courseData && !window.classroomTabInstance) {
      window.classroomTabInstance = new window.ClassroomTab(window.courseData);
    }
  });
</script>
