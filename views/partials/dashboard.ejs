<!-- Dashboard Tab -->
<div id="dashboard" class="tab-content" style="display: none">
  <div class="dashboard-header">
    <h3>Group Dashboard</h3>
    <p>Manage your group settings and members</p>
  </div>

  <div class="dashboard-tabs">
    <button class="dashboard-tab-btn active" onclick="showDashboardSection('members', event)">
      Members
    </button>
    <button class="dashboard-tab-btn" onclick="showDashboardSection('missions', event)">
      Missions
    </button>
    <button class="dashboard-tab-btn" onclick="showDashboardSection('content', event)">
      Content
    </button>
    <button class="dashboard-tab-btn" onclick="showDashboardSection('settings', event)">
      Group Settings
    </button>
  </div>

  <div class="dashboard-content">
    <!-- Members Section -->
    <div id="dashboard-members" class="dashboard-section active">
      <h4>Member Management</h4>
      <div class="members-management">
        <div class="search-section">
          <input type="text" id="memberSearch" placeholder="Search members..." onkeyup="searchMembers()">
        </div>
        <div id="adminMembersList" class="members-list">
          <!-- Members will be loaded here with admin controls -->
        </div>
        <div class="admin-actions">
          <button class="btn btn-primary" onclick="showInviteModal()">
            Invite New Member
          </button>
          <button class="btn btn-secondary" onclick="exportMembers()">
            Export Members List
          </button>
        </div>
      </div>
    </div>

    <!-- Missions Section -->
    <div id="dashboard-missions" class="dashboard-section">
      <h4>Mission Management</h4>
      <div class="missions-management">
        <div class="missions-stats">
          <div class="stat-card">
            <h5>Active Missions</h5>
            <span id="activeMissionsCount">0</span>
          </div>
          <div class="stat-card">
            <h5>Completed</h5>
            <span id="completedMissionsCount">0</span>
          </div>
          <div class="stat-card">
            <h5>Pending</h5>
            <span id="pendingMissionsCount">0</span>
          </div>
        </div>
        <div class="missions-actions">
          <button class="btn btn-primary" onclick="createNewMission()">
            Create New Mission
          </button>
          <button class="btn btn-secondary" onclick="viewAllMissions()">
            View All Missions
          </button>
        </div>
        <div id="missionsList" class="missions-list">
          <!-- Missions will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Content Section -->
    <div id="dashboard-content" class="dashboard-section">
      <h4>Content Management</h4>
      <div class="content-management">
        <div class="content-stats">
          <div class="stat-card">
            <h5>Total Posts</h5>
            <span id="totalPostsCount">0</span>
          </div>
          <div class="stat-card">
            <h5>This Week</h5>
            <span id="weeklyPostsCount">0</span>
          </div>
          <div class="stat-card">
            <h5>Comments</h5>
            <span id="totalCommentsCount">0</span>
          </div>
        </div>
        
        <div class="content-filters">
          <input type="text" id="contentSearch" placeholder="Search posts and comments..." onkeyup="searchContent()">
          <select id="contentSort" onchange="loadContentManagement()">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="most-comments">Most Comments</option>
            <option value="most-votes">Most Votes</option>
          </select>
        </div>

        <div class="posts-management">
          <h5>All Posts</h5>
          <div id="adminPostsList" class="admin-posts-list">
            <!-- Posts will be loaded here with admin controls -->
          </div>
        </div>
      </div>
    </div>

    <!-- Group Settings Section -->
    <div id="dashboard-settings" class="dashboard-section">
      <h4>Group Settings</h4>
      <div class="settings-management">
        <form id="groupSettingsForm">
          <div class="form-group">
            <label for="groupName">Group Name</label>
            <input type="text" id="groupName" name="name" value="<%= group.name %>" class="form-control">
          </div>
          
          <div class="form-group">
            <label for="groupSpecialization">Specialization</label>
            <select id="groupSpecialization" name="specialization" class="form-control">
              <option value="JavaScript" <%= group.specialization === 'JavaScript' ? 'selected' : '' %>>JavaScript</option>
              <option value="React" <%= group.specialization === 'React' ? 'selected' : '' %>>React</option>
              <option value="Node.js" <%= group.specialization === 'Node.js' ? 'selected' : '' %>>Node.js</option>
              <option value="Python" <%= group.specialization === 'Python' ? 'selected' : '' %>>Python</option>
              <option value="SQL" <%= group.specialization === 'SQL' ? 'selected' : '' %>>SQL</option>
            </select>
          </div>
          
          <!-- Add Description Field to Settings -->
          <div class="form-group">
            <label for="groupDescription">Group Description</label>
            <textarea 
              id="groupDescription" 
              name="description" 
              class="form-control" 
              rows="4" 
              placeholder="Describe your group's purpose, goals, or any important information..."
              maxlength="500"
            ><%= group.description || '' %></textarea>
            <small class="form-text text-muted">
              <span id="descriptionCharCount"><%= group.description ? group.description.length : 0 %></span>/500 characters
            </small>
          </div>
          
          <div class="form-group">
            <label for="groupVisibility">Group Visibility</label>
            <select id="groupVisibility" name="visibility" class="form-control">
              <option value="public">Public</option>
              <option value="private">Private</option>
              <option value="invite-only">Invite Only</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="allowMemberPosts" checked> 
              Allow members to create posts
            </label>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="allowMemberInvites" checked> 
              Allow members to invite others
            </label>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-primary" onclick="saveGroupSettings()">
              Save Settings
            </button>
            <button type="button" class="btn btn-danger" onclick="showDeleteGroupModal()">
              Delete Group
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Mission Creation Modal -->
<div id="missionModal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h4>Create New Mission</h4>
      <span class="close" onclick="closeMissionModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="missionForm">
        <div class="form-group">
          <label for="missionTitle">Mission Title</label>
          <input type="text" id="missionTitle" name="title" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label for="missionDescription">Description</label>
          <textarea id="missionDescription" name="description" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="missionType">Question Type</label>
          <select id="missionType" name="type" class="form-control" onchange="toggleQuestionType()">
            <option value="system">Use System Questions</option>
            <option value="custom" selected>Create Custom Questions</option>
          </select>
        </div>
        
        <!-- Mission Duration Section -->
        <div class="form-group">
          <label for="missionDuration">Mission Duration (Days)</label>
          <select id="missionDuration" name="duration" class="form-control" onchange="updateMissionRequirements()" required>
            <option value="">Select duration</option>
            <option value="1">1 Day</option>
            <option value="2">2 Days</option>
            <option value="3">3 Days</option>
            <option value="4">4 Days</option>
            <option value="5">5 Days</option>
            <option value="6">6 Days</option>
            <option value="7">7 Days</option>
          </select>
          <small class="form-text text-muted">Mission will be available for 1-7 days</small>
        </div>
        
        <!-- Requirements Display -->
        <div class="requirements-card">
          <h5>Mission Requirements</h5>
          <div class="requirements-info">
            <div class="requirement-item">
              <span class="requirement-label">Minimum Questions Required:</span>
              <span id="minQuestionsRequired" class="requirement-value">0</span>
            </div>
            <div class="requirement-item">
              <span class="requirement-label">Total Points Reward:</span>
              <span id="totalPointsReward" class="requirement-value">0</span>
            </div>
            <div class="requirement-item">
              <span class="requirement-label">Questions Added:</span>
              <span id="questionsAdded" class="requirement-value">0</span>
            </div>
            <div class="requirement-item">
              <span class="requirement-status" id="requirementsStatus">Please select mission duration</span>
            </div>
          </div>
        </div>
        
        <!-- Custom Questions Section -->
        <div id="customQuestionsSection">
          <div class="section-header">
            <h5>Custom Questions</h5>
            <button type="button" class="btn btn-sm btn-primary" onclick="addQuestion()" id="addQuestionBtn">
              Add Question
            </button>
          </div>
          
          <div id="questionsContainer">
            <!-- Questions will be added here dynamically -->
          </div>
        </div>
        
        <!-- Hidden fields for calculated values -->
        <input type="hidden" id="missionPoints" name="points" value="0">
        <input type="hidden" id="missionDeadline" name="deadline">
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeMissionModal()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="createMissionBtn" disabled>
            Create Mission
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .requirements-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  .requirements-card h5 {
    margin-top: 0;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
  }
  
  .requirement-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
  }
  
  .requirement-label {
    font-weight: 500;
    color: #6c757d;
  }
  
  .requirement-value {
    font-weight: 600;
    color: #495057;
  }
  
  .requirement-status {
    font-weight: 500;
    padding: 8px;
    border-radius: 4px;
    text-align: center;
    display: block;
    margin-top: 10px;
  }
  
  .status-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }
  
  .status-met {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }
  
  .status-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .question-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
  }
  
  .choices-container {
    margin: 15px 0;
  }
  
  .choice-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 10px;
  }
  
  .choice-row input[type="radio"] {
    margin: 0;
  }
  
  .choice-input {
    flex: 1;
  }
</style>

<script>
  // Dashboard-specific JavaScript
  let currentDashboardSection = 'members';
  let questionCounter = 0;
  let currentDuration = 0;
  let minQuestionsRequired = 0;

  // Utility function to safely get elements
  function getElement(id) {
    const element = document.getElementById(id);
    if (!element) {
      console.warn(`Element with id '${id}' not found`);
    }
    return element;
  }

  function showDashboardSection(sectionId, event) {
    // Hide all sections
    const sections = document.querySelectorAll(".dashboard-section");
    sections.forEach((section) => {
      section.classList.remove("active");
    });

    // Remove active class from all buttons
    const buttons = document.querySelectorAll(".dashboard-tab-btn");
    buttons.forEach((btn) => {
      btn.classList.remove("active");
    });

    // Show selected section and activate button
    const selectedSection = getElement(`dashboard-${sectionId}`);
    if (selectedSection) {
      selectedSection.classList.add("active");
    }
    
    if (event && event.currentTarget) {
      event.currentTarget.classList.add("active");
    }
    
    currentDashboardSection = sectionId;
    
    // Load section-specific data
    switch(sectionId) {
      case 'members':
        loadMembersManagement();
        break;
      case 'missions':
        loadMissionsManagement();
        break;
      case 'content':
        loadContentManagement();
        break;
      case 'settings':
        loadGroupSettings();
        break;
    }
  }

  // Initialize dashboard when it becomes visible
  function initializeDashboard() {
    console.log('Initializing dashboard...');
    // Load initial data for the active section
    showDashboardSection(currentDashboardSection);
  }

  // Mission Management Functions
  function createNewMission() {
    const modal = getElement('missionModal');
    if (modal) {
      modal.style.display = 'block';
      resetMissionForm();
    }
  }

  function closeMissionModal() {
    const modal = getElement('missionModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  function resetMissionForm() {
    const form = getElement('missionForm');
    const questionsContainer = getElement('questionsContainer');
    const durationSelect = getElement('missionDuration');
    
    if (form) form.reset();
    if (questionsContainer) questionsContainer.innerHTML = '';
    if (durationSelect) durationSelect.value = '';
    
    questionCounter = 0;
    currentDuration = 0;
    minQuestionsRequired = 0;
    updateMissionRequirements();
    
    // Reset the add question button
    const addQuestionBtn = getElement('addQuestionBtn');
    if (addQuestionBtn) {
      addQuestionBtn.disabled = false;
    }
  }

  function toggleQuestionType() {
    const missionType = getElement('missionType');
    const customSection = getElement('customQuestionsSection');
    
    if (missionType && customSection) {
      if (missionType.value === 'system') {
        customSection.style.display = 'none';
        // For system questions, we don't need to validate custom questions
        validateMissionRequirements();
      } else {
        customSection.style.display = 'block';
        validateMissionRequirements();
      }
    }
  }

  function updateMissionRequirements() {
    const durationSelect = getElement('missionDuration');
    const missionType = getElement('missionType');
    
    if (!durationSelect || !missionType) return;
    
    currentDuration = parseInt(durationSelect.value) || 0;
    
    // Calculate minimum questions required (5 per day)
    minQuestionsRequired = currentDuration * 5;
    
    // Calculate total points (50 points per question)
    const totalPoints = minQuestionsRequired * 50;
    
    // Update the display
    const minQuestionsElement = getElement('minQuestionsRequired');
    const totalPointsElement = getElement('totalPointsReward');
    const questionsAddedElement = getElement('questionsAdded');
    const statusElement = getElement('requirementsStatus');
    const pointsInput = getElement('missionPoints');
    
    if (minQuestionsElement) minQuestionsElement.textContent = minQuestionsRequired;
    if (totalPointsElement) totalPointsElement.textContent = totalPoints;
    if (questionsAddedElement) questionsAddedElement.textContent = questionCounter;
    if (pointsInput) pointsInput.value = totalPoints;
    
    // Calculate and set deadline (current time + duration days)
    if (currentDuration > 0) {
      const deadline = new Date();
      deadline.setDate(deadline.getDate() + currentDuration);
      const deadlineInput = getElement('missionDeadline');
      if (deadlineInput) {
        deadlineInput.value = deadline.toISOString().slice(0, 16);
      }
    }
    
    // Update status
    if (currentDuration === 0) {
      if (statusElement) {
        statusElement.textContent = 'Please select mission duration';
        statusElement.className = 'requirement-status status-pending';
      }
    } else if (missionType.value === 'system') {
      if (statusElement) {
        statusElement.textContent = 'System questions will be automatically assigned';
        statusElement.className = 'requirement-status status-met';
      }
    } else {
      validateMissionRequirements();
    }
    
    // Update add question button state
    const addQuestionBtn = getElement('addQuestionBtn');
    if (addQuestionBtn && missionType.value === 'custom') {
      addQuestionBtn.disabled = questionCounter >= minQuestionsRequired;
    }
  }

  function validateMissionRequirements() {
    const missionType = getElement('missionType');
    const statusElement = getElement('requirementsStatus');
    const createBtn = getElement('createMissionBtn');
    
    if (!missionType || !statusElement || !createBtn) return;
    
    if (missionType.value === 'system') {
      // For system questions, requirements are always met
      statusElement.textContent = 'System questions will be automatically assigned';
      statusElement.className = 'requirement-status status-met';
      createBtn.disabled = currentDuration === 0;
      return;
    }
    
    // For custom questions
    if (currentDuration === 0) {
      statusElement.textContent = 'Please select mission duration';
      statusElement.className = 'requirement-status status-pending';
      createBtn.disabled = true;
    } else if (questionCounter < minQuestionsRequired) {
      statusElement.textContent = `Need ${minQuestionsRequired - questionCounter} more questions`;
      statusElement.className = 'requirement-status status-error';
      createBtn.disabled = true;
    } else {
      statusElement.textContent = 'All requirements met! Mission can be created';
      statusElement.className = 'requirement-status status-met';
      createBtn.disabled = false;
    }
  }

  function addQuestion() {
    if (questionCounter >= minQuestionsRequired && minQuestionsRequired > 0) {
      alert(`Maximum questions reached for ${currentDuration}-day mission. Maximum allowed: ${minQuestionsRequired}`);
      return;
    }
    
    questionCounter++;
    const questionsContainer = getElement('questionsContainer');
    
    if (!questionsContainer) return;
    
    const questionHtml = `
      <div class="question-card" data-question-id="${questionCounter}">
        <div class="question-header">
          <h6>Question ${questionCounter}</h6>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(${questionCounter})" ${questionCounter === 1 ? 'disabled' : ''}>
            Remove
          </button>
        </div>
        
        <div class="form-group">
          <label>Question Text</label>
          <input type="text" name="questions[${questionCounter}][text]" class="form-control" required oninput="validateQuestionInput(this)">
        </div>
        
        <div class="choices-container">
          <label>Choices (Mark the correct answer)</label>
          ${[1, 2, 3, 4].map(choiceNum => `
            <div class="choice-row">
              <input type="radio" name="questions[${questionCounter}][correctAnswer]" value="${choiceNum - 1}" ${choiceNum === 1 ? 'checked' : ''} required>
              <input type="text" name="questions[${questionCounter}][choices][${choiceNum - 1}]" class="form-control choice-input" placeholder="Choice ${choiceNum}" required oninput="validateQuestionInput(this)">
            </div>
          `).join('')}
        </div>
        
        <div class="form-group">
          <label>Explanation (Optional)</label>
          <textarea name="questions[${questionCounter}][explanation]" class="form-control" rows="2" placeholder="Explain why the correct answer is right..."></textarea>
        </div>
      </div>
    `;
    
    questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
    
    // Update requirements
    updateQuestionsAdded();
    validateMissionRequirements();
    
    // Update add question button state
    const addQuestionBtn = getElement('addQuestionBtn');
    const missionType = getElement('missionType');
    if (addQuestionBtn && missionType && missionType.value === 'custom') {
      addQuestionBtn.disabled = questionCounter >= minQuestionsRequired;
    }
  }

  function validateQuestionInput(input) {
    // Basic validation - you can extend this as needed
    if (input.value.trim() === '') {
      input.style.borderColor = '#dc3545';
    } else {
      input.style.borderColor = '#28a745';
    }
  }

  function removeQuestion(questionId) {
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    if (questionElement) {
      questionElement.remove();
      // Renumber remaining questions
      renumberQuestions();
      // Update requirements
      updateQuestionsAdded();
      validateMissionRequirements();
      
      // Update add question button state
      const addQuestionBtn = getElement('addQuestionBtn');
      if (addQuestionBtn) {
        addQuestionBtn.disabled = questionCounter >= minQuestionsRequired;
      }
    }
  }

  function updateQuestionsAdded() {
    const questionsAddedElement = getElement('questionsAdded');
    if (questionsAddedElement) {
      questionsAddedElement.textContent = questionCounter;
    }
  }

  function renumberQuestions() {
    const questionCards = document.querySelectorAll('.question-card');
    questionCounter = 0;
    
    questionCards.forEach((card, index) => {
      questionCounter++;
      const newQuestionId = questionCounter;
      card.setAttribute('data-question-id', newQuestionId);
      
      // Update question header
      const header = card.querySelector('h6');
      if (header) header.textContent = `Question ${newQuestionId}`;
      
      // Update input names
      const questionInputs = card.querySelectorAll('[name*="questions"]');
      questionInputs.forEach(input => {
        const name = input.getAttribute('name');
        const newName = name.replace(/questions\[\d+\]/, `questions[${newQuestionId}]`);
        input.setAttribute('name', newName);
      });
      
      // Update remove button
      const removeBtn = card.querySelector('button');
      if (removeBtn) {
        removeBtn.setAttribute('onclick', `removeQuestion(${newQuestionId})`);
        removeBtn.disabled = newQuestionId === 1;
      }
    });
  }

  // Handle mission form submission
  document.addEventListener('DOMContentLoaded', function() {
    const missionForm = getElement('missionForm');
    if (missionForm) {
      missionForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!isAdmin) {
          alert('Only admins can create missions');
          return;
        }
        
        const formData = new FormData(this);
        const missionData = {
          title: formData.get('title'),
          description: formData.get('description'),
          type: formData.get('type'),
          duration: parseInt(formData.get('duration')),
          points: parseInt(formData.get('points')),
          deadline: formData.get('deadline') || null
        };
        
        // Validate duration
        if (missionData.duration < 1 || missionData.duration > 7) {
          alert('Mission duration must be between 1 and 7 days');
          return;
        }
        
        // Process custom questions if type is custom
        if (missionData.type === 'custom') {
          missionData.questions = processCustomQuestions(formData);
          
          if (missionData.questions.length === 0) {
            alert('Please add at least one question');
            return;
          }
          
          // Validate minimum questions requirement
          const minQuestionsRequired = missionData.duration * 5;
          if (missionData.questions.length < minQuestionsRequired) {
            alert(`For a ${missionData.duration}-day mission, you need at least ${minQuestionsRequired} questions`);
            return;
          }
        }
        
        try {
          const response = await fetch(`/groups/${groupId}/missions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(missionData)
          });
          
          if (response.ok) {
            alert('Mission created successfully!');
            closeMissionModal();
            loadMissionsManagement(); // Refresh missions list
          } else {
            const error = await response.json();
            alert('Error creating mission: ' + error.error);
          }
        } catch (error) {
          console.error('Error creating mission:', error);
          alert('Error creating mission');
        }
      });
    }
  });

  function processCustomQuestions(formData) {
    const questions = [];
    const questionMap = new Map();
    
    // Group form data by question
    for (const [key, value] of formData.entries()) {
      const match = key.match(/questions\[(\d+)\]\[(\w+)\](?:\[(\d+)\])?/);
      if (match) {
        const [, questionId, field, index] = match;
        
        if (!questionMap.has(questionId)) {
          questionMap.set(questionId, {
            text: '',
            choices: ['', '', '', ''],
            correctAnswer: 0,
            explanation: ''
          });
        }
        
        const question = questionMap.get(questionId);
        
        if (field === 'text') {
          question.text = value;
        } else if (field === 'choices' && index !== undefined) {
          question.choices[parseInt(index)] = value;
        } else if (field === 'correctAnswer') {
          question.correctAnswer = parseInt(value);
        } else if (field === 'explanation') {
          question.explanation = value;
        }
      }
    }
    
    // Convert map to array and validate
    for (const [questionId, question] of questionMap) {
      if (question.text.trim() && question.choices.every(choice => choice.trim())) {
        questions.push(question);
      }
    }
    
    return questions;
  }

  // Load missions management
  async function loadMissionsManagement() {
    if (!isAdmin) return;
    
    try {
      const response = await fetch(`/groups/${groupId}/missions`);
      const missions = await response.json();
      
      const missionsList = getElement('missionsList');
      if (missionsList) {
        if (!missions || missions.length === 0) {
          missionsList.innerHTML = `
            <div class="empty-state">
              <i>🎯</i>
              <p>No missions created yet</p>
              <button class="btn btn-primary" onclick="createNewMission()">
                Create Your First Mission
              </button>
            </div>
          `;
        } else {
          missionsList.innerHTML = missions.map(mission => `
            <div class="mission-card">
              <div class="mission-header">
                <h5>${mission.title}</h5>
                <span class="mission-status ${mission.status}">${mission.status}</span>
              </div>
              <p class="mission-description">${mission.description || 'No description'}</p>
              <div class="mission-details">
                <span>Type: ${mission.type}</span>
                <span>Duration: ${mission.duration || 'N/A'} days</span>
                <span>Questions: ${mission.questions ? mission.questions.length : 'System'}</span>
                <span>Points: ${mission.points}</span>
                ${mission.deadline ? `<span>Deadline: ${new Date(mission.deadline).toLocaleDateString()}</span>` : ''}
              </div>
              <div class="mission-actions">
                <button class="btn btn-sm btn-primary" onclick="viewMission('${mission._id}')">
                  View
                </button>
                <button class="btn btn-sm btn-secondary" onclick="editMission('${mission._id}')">
                  Edit
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteMission('${mission._id}')">
                  Delete
                </button>
              </div>
            </div>
          `).join('');
        }
      }
      
      // Update mission stats
      updateMissionStats(missions);
    } catch (error) {
      console.error('Error loading missions:', error);
    }
  }

  function updateMissionStats(missions) {
    // Safely update stats
    const activeElement = getElement('activeMissionsCount');
    const completedElement = getElement('completedMissionsCount');
    const pendingElement = getElement('pendingMissionsCount');
    
    if (!missions || !Array.isArray(missions)) {
      if (activeElement) activeElement.textContent = '0';
      if (completedElement) completedElement.textContent = '0';
      if (pendingElement) pendingElement.textContent = '0';
      return;
    }
    
    const activeMissions = missions.filter(m => m.status === 'active').length;
    const completedMissions = missions.filter(m => m.status === 'completed').length;
    const pendingMissions = missions.filter(m => m.status === 'pending').length;
    
    if (activeElement) activeElement.textContent = activeMissions;
    if (completedElement) completedElement.textContent = completedMissions;
    if (pendingElement) pendingElement.textContent = pendingMissions;
  }

  // Stub functions for mission actions
  function viewMission(missionId) {
    alert(`View mission ${missionId} - to be implemented`);
  }

  function editMission(missionId) {
    alert(`Edit mission ${missionId} - to be implemented`);
  }

  async function deleteMission(missionId) {
    if (!confirm('Are you sure you want to delete this mission?')) return;
    
    try {
      const response = await fetch(`/groups/${groupId}/missions/${missionId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        alert('Mission deleted successfully');
        loadMissionsManagement();
      } else {
        const error = await response.json();
        alert('Error deleting mission: ' + error.error);
      }
    } catch (error) {
      console.error('Error deleting mission:', error);
      alert('Error deleting mission');
    }
  }

  // Initialize when dashboard tab is shown
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on the dashboard tab
    const dashboardTab = getElement('dashboard');
    if (dashboardTab) {
      // Initialize mission form
      const missionType = getElement('missionType');
      if (missionType) {
        missionType.value = 'custom';
        toggleQuestionType();
      }
    }
  });

  // Your existing dashboard functions
  async function loadDashboardData() {
    if (!isAdmin) return;
    
    try {
      const response = await fetch(`/groups/${groupId}/dashboard`);
      const data = await response.json();
      
      if (response.ok) {
        updateDashboardStats(data.stats);
        if (currentDashboardSection === 'members') {
          loadMembersManagement();
        }
      } else {
        console.error('Failed to load dashboard data:', data.error);
      }
    } catch (error) {
      console.error('Error loading dashboard data:', error);
    }
  }

  function updateDashboardStats(stats) {
    if (!stats) return;
    
    const totalPosts = getElement('totalPostsCount');
    const weeklyPosts = getElement('weeklyPostsCount');
    const totalComments = getElement('totalCommentsCount');
    
    if (totalPosts) totalPosts.textContent = stats.totalPosts || 0;
    if (weeklyPosts) weeklyPosts.textContent = stats.weeklyPosts || 0;
    if (totalComments) totalComments.textContent = stats.totalComments || 0;
  }

  async function loadMembersManagement() {
    if (!isAdmin) return;
    
    try {
      const response = await fetch(`/groups/${groupId}/members`);
      const members = await response.json();
      
      const membersList = getElement('adminMembersList');
      if (membersList && members) {
        membersList.innerHTML = members.map(member => `
          <div class="member-management-card">
            <div class="member-info">
              <h5>${member.user?.fullName || 'Unknown User'}</h5>
              <p>Level: ${member.user?.level || 'N/A'} | Role: ${member.role}</p>
              <small>Joined: ${new Date(member.joinedAt || Date.now()).toLocaleDateString()}</small>
            </div>
            <div class="member-actions">
              <select onchange="updateMemberRole('${member.user?._id}', this.value)" ${member.role === 'Admin' ? 'disabled' : ''}>
                <option value="Member" ${member.role === 'Member' ? 'selected' : ''}>Member</option>
                <option value="Contributor" ${member.role === 'Contributor' ? 'selected' : ''}>Contributor</option>
                <option value="Strategist" ${member.role === 'Strategist' ? 'selected' : ''}>Strategist</option>
                <option value="Challenger" ${member.role === 'Challenger' ? 'selected' : ''}>Challenger</option>
                <option value="Admin" ${member.role === 'Admin' ? 'selected' : ''}>Admin</option>
              </select>
              <button class="btn btn-sm btn-danger" onclick="removeMember('${member.user?._id}')" ${member.role === 'Admin' ? 'disabled' : ''}>
                Remove
              </button>
            </div>
          </div>
        `).join('');
      }
    } catch (error) {
      console.error('Error loading members:', error);
    }
  }

  async function updateMemberRole(userId, newRole) {
    if (!isAdmin || !userId) return;
    
    try {
      const response = await fetch(`/groups/${groupId}/members/${userId}/role`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ role: newRole })
      });
      
      if (response.ok) {
        alert('Member role updated successfully');
        loadMembersManagement();
      } else {
        const error = await response.json();
        alert('Error updating role: ' + error.error);
      }
    } catch (error) {
      console.error('Error updating member role:', error);
      alert('Error updating member role');
    }
  }

  async function removeMember(userId) {
    if (!isAdmin || !userId) return;
    if (!confirm('Are you sure you want to remove this member?')) return;
    
    try {
      const response = await fetch(`/groups/${groupId}/members/${userId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        alert('Member removed successfully');
        loadMembersManagement();
      } 
      else {
        const error = await response.json();
        }
    }
      catch (error) {
        console.error('Error removing member:', error);
        alert('Error removing member');
        }
    }

  async function saveGroupSettings() {
    if (!isAdmin) return;
    
    const form = getElement('groupSettingsForm');
    if (!form) return;
    
    const formData = new FormData(form);
    const settings = Object.fromEntries(formData.entries());
    
    try {
      const response = await fetch(`/groups/${groupId}/settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
      });
      
      if (response.ok) {
        alert('Group settings updated successfully');
        // Update the description display if it was changed
        if (settings.description !== undefined) {
          updateDescriptionDisplay(settings.description);
        }
      } else {
        const error = await response.json();
        alert('Error updating settings: ' + error.error);
      }
    } catch (error) {
      console.error('Error updating group settings:', error);
      alert('Error updating group settings');
    }
  }

  function loadGroupSettings() {
    // Settings are already pre-populated in the HTML
    console.log('Loading group settings...');
    
    // Initialize settings description character count
    const groupDescription = getElement('groupDescription');
    if (groupDescription) {
      groupDescription.addEventListener('input', function() {
        const charCount = getElement('descriptionCharCount');
        if (charCount) {
          charCount.textContent = this.value.length;
        }
      });
    }
  }

  // Content Management Functions
  async function loadContentManagement() {
    if (!isAdmin) return;
    
    try {
      const sortBy = document.getElementById('contentSort')?.value || 'newest';
      const response = await fetch(`/groups/${groupId}/dashboard/content?sort=${sortBy}`);
      const data = await response.json();
      
      if (response.ok) {
        renderAdminPosts(data.posts);
      } else {
        console.error('Failed to load content:', data.error);
      }
    } catch (error) {
      console.error('Error loading content:', error);
    }
  }

  function renderAdminPosts(posts) {
    const container = document.getElementById('adminPostsList');
    if (!container) return;

    if (!posts || posts.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i>📝</i>
          <p>No posts found in this group</p>
        </div>
      `;
      return;
    }

    container.innerHTML = posts.map(post => `
      <div class="admin-post-card" data-post-id="${post._id}">
        <div class="admin-post-header">
          <div class="post-author-info">
            <h6>${post.author?.fullName || 'Unknown User'}</h6>
            <div class="post-meta">
              ${new Date(post.createdAt).toLocaleString()} | 
              Level ${post.author?.level || 'N/A'}
            </div>
          </div>
          <div class="post-stats">
            <span>▲ ${post.votes || 0}</span>
            <span>💬 ${post.comments ? post.comments.length : 0}</span>
          </div>
        </div>
        
        <div class="post-content">
          ${post.content}
        </div>
        
        <div class="post-actions-admin">
          <button class="btn btn-sm btn-danger" onclick="deletePost('${post._id}')">
            Delete Post
          </button>
          <button class="btn btn-sm btn-secondary" onclick="toggleCommentsAdmin('${post._id}')">
            ${post.comments && post.comments.length > 0 ? `Manage Comments (${post.comments.length})` : 'No Comments'}
          </button>
        </div>
        
        <div class="admin-comments-section" id="admin-comments-${post._id}" style="display: none;">
          <h6>Comments</h6>
          <div id="admin-comments-list-${post._id}">
            ${renderAdminComments(post.comments)}
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderAdminComments(comments) {
    if (!comments || comments.length === 0) {
      return '<p class="no-comments">No comments yet</p>';
    }

    return comments.map(comment => `
      <div class="comment-item" data-comment-id="${comment._id}">
        <div class="comment-header">
          <span class="comment-author">${comment.author?.fullName || 'Unknown User'}</span>
          <span class="comment-meta">
            ${new Date(comment.createdAt).toLocaleString()} | 
            Level ${comment.author?.level || 'N/A'}
          </span>
        </div>
        <div class="comment-content">${comment.content}</div>
        <div class="comment-actions">
          <button class="btn btn-sm btn-danger" onclick="deleteComment('${comment._id}', '${comment.postId}')">
            Delete Comment
          </button>
        </div>
      </div>
    `).join('');
  }

  function toggleCommentsAdmin(postId) {
    const commentsSection = document.getElementById(`admin-comments-${postId}`);
    if (commentsSection) {
      commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
    }
  }

  async function deletePost(postId) {
    if (!isAdmin || !confirm('Are you sure you want to delete this post? This will also delete all comments and cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch(`/groups/posts/${postId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('Post deleted successfully');
        loadContentManagement(); // Reload the content
      } else {
        const error = await response.json();
        alert('Error deleting post: ' + error.error);
      }
    } catch (error) {
      console.error('Error deleting post:', error);
      alert('Error deleting post');
    }
  }

  async function deleteComment(commentId, postId) {
    if (!isAdmin || !confirm('Are you sure you want to delete this comment?')) {
      return;
    }

    try {
      const response = await fetch(`/groups/comments/${commentId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('Comment deleted successfully');
        // Refresh the comments for this post
        loadContentManagement();
      } else {
        const error = await response.json();
        alert('Error deleting comment: ' + error.error);
      }
    } catch (error) {
      console.error('Error deleting comment:', error);
      alert('Error deleting comment');
    }
  }

  function searchContent() {
    const searchTerm = document.getElementById('contentSearch')?.value.toLowerCase();
    const postCards = document.querySelectorAll('.admin-post-card');
    
    postCards.forEach(card => {
      const content = card.querySelector('.post-content')?.textContent.toLowerCase() || '';
      const author = card.querySelector('.post-author-info h6')?.textContent.toLowerCase() || '';
      const comments = card.querySelector('.admin-comments-section')?.textContent.toLowerCase() || '';
      
      const matches = content.includes(searchTerm) || 
                    author.includes(searchTerm) || 
                    comments.includes(searchTerm);
      
      card.style.display = matches ? 'block' : 'none';
    });
  }

  // Stub functions for dashboard actions
  function searchMembers() {
    console.log('Searching members...');
  }

  function showInviteModal() {
    alert('Invite modal would open here');
  }

  function exportMembers() {
    alert('Export members functionality');
  }

  function viewAllMissions() {
    alert('View all missions functionality');
  }

  function showDeleteGroupModal() {
    if (confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
      alert('Group deletion functionality');
    }
  }

  function updateDescriptionDisplay(description) {
    // This function would update the description display in the group header
    console.log('Description updated to:', description);
  }
</script>