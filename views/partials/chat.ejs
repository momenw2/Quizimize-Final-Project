<!-- Chat Tab -->
<div id="chat" class="tab-content" style="display: none">
  <div class="chat-header">
    <h3>Group Chat</h3>
    <div class="online-indicator">
      <span id="onlineCount">0</span> members online
    </div>
  </div>

  <div class="chat-container">
    <div id="chatMessages" class="chat-messages">
      <!-- Chat messages will appear here -->
    </div>

    <div class="chat-input-container">
      <div class="typing-indicator" id="typingIndicator" style="display: none">
        <span id="typingUsers"></span> is typing...
      </div>

      <div class="chat-input-group">
        <input
          type="text"
          id="chatMessageInput"
          placeholder="Type a message..."
          maxlength="500"
          onkeypress="handleChatKeyPress(event)"
        />
        <button id="sendMessageBtn" onclick="sendChatMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Chat-specific JavaScript - remove the duplicate declarations
  // These are now global variables defined at the top

  function initializeSocket() {
    // Only initialize once
    if (socket) {
      return socket;
    }

    console.log("Initializing socket connection...");
    socket = io();

    // Send authentication data when connecting
    socket.emit("authenticate", {
      userId: "<%= user._id %>",
      userName: "<%= user.fullName %>",
    });

    // Set up event listeners only once
    setupSocketListeners();

    return socket;
  }

  function setupSocketListeners() {
    if (!socket) return;

    // Remove any existing listeners first to prevent duplicates
    socket.off("chat-message");
    socket.off("chat-history");
    socket.off("user-joined-chat");
    socket.off("user-left-chat");
    socket.off("typing-start");
    socket.off("typing-stop");
    socket.off("online-count");

    // Chat event handlers
    socket.on("chat-message", (data) => {
      console.log("Received chat message:", data);
      addChatMessage(data);
    });

    socket.on("chat-history", (messages) => {
      console.log("Received chat history:", messages?.length, "messages");
      renderChatHistory(messages);
    });

    socket.on("user-joined-chat", (data) => {
      console.log("User joined:", data);
      addSystemMessage(`${data.userName} joined the chat`);
      updateOnlineCount(data.onlineCount);
    });

    socket.on("user-left-chat", (data) => {
      console.log("User left:", data);
      addSystemMessage(`${data.userName} left the chat`);
      updateOnlineCount(data.onlineCount);
    });

    socket.on("typing-start", (data) => {
      console.log("Typing start:", data);
      showTypingIndicator(data.userName, data.userId);
    });

    socket.on("typing-stop", (data) => {
      console.log("Typing stop:", data);
      hideTypingIndicator(data.userId);
    });

    socket.on("online-count", (count) => {
      console.log("Online count:", count);
      updateOnlineCount(count);
    });
  }

  function initializeChat() {
    if (chatInitialized) {
      console.log("Chat already initialized");
      return;
    }

    console.log("Initializing chat...");

    // Make sure socket is initialized
    if (!socket) {
      initializeSocket();
    }

    // Join group room
    if (socket) {
      socket.emit("join-group", groupId);
      loadChatHistory();
    }

    chatInitialized = true;
  }

  function destroyChat() {
    console.log("Destroying chat state...");

    // Leave group room but keep socket connection
    if (socket) {
      socket.emit("leave-group", groupId);
    }

    // Clear chat state but don't disconnect socket
    chatInitialized = false;

    // Clear typing indicators
    hideTypingIndicator();
    stopTyping();
  }

  function loadChatHistory() {
    if (socket) {
      console.log("Loading chat history for group:", groupId);
      socket.emit("get-chat-history", groupId);
    }
  }

  function renderChatHistory(messages) {
    const container = getElement("chatMessages");
    if (container && messages) {
      console.log("Rendering chat history with", messages.length, "messages");
      container.innerHTML = messages
        .map((message) => createChatMessageHTML(message))
        .join("");
      scrollChatToBottom();
    } else {
      console.log("No messages to render or container not found");
    }
  }

  function addChatMessage(data) {
    // Check if message already exists to prevent duplicates
    if (data._id) {
      const existingMessage = document.querySelector(
        `[data-message-id="${data._id}"]`
      );
      if (existingMessage) {
        console.log("Message already exists, skipping:", data._id);
        return;
      }
    }

    const container = getElement("chatMessages");
    if (container && data) {
      const messageHTML = createChatMessageHTML(data);
      container.insertAdjacentHTML("beforeend", messageHTML);
      scrollChatToBottom();
      hideTypingIndicator(data.userId);
    }
  }

  function createChatMessageHTML(message) {
    if (!message) return "";

    const isCurrentUser = message.userId === "<%= user._id %>";
    const messageClass = isCurrentUser
      ? "message own-message"
      : "message other-message";

    return `
      <div class="${messageClass}" data-message-id="${message._id || ""}">
        <div class="message-header">
          <span class="message-sender">${message.userName || "Unknown"}</span>
          <span class="message-time">${new Date(
            message.timestamp || Date.now()
          ).toLocaleTimeString()}</span>
        </div>
        <div class="message-content">${message.content || ""}</div>
      </div>
    `;
  }

  function addSystemMessage(content) {
    const container = getElement("chatMessages");
    if (container && content) {
      const messageHTML = `
        <div class="message system-message">
          <div class="message-content">${content}</div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", messageHTML);
      scrollChatToBottom();
    }
  }

  function sendChatMessage() {
    const input = getElement("chatMessageInput");
    if (!input) return;

    const content = input.value.trim();
    if (!content) return;

    const messageData = {
      groupId: groupId,
      content: content,
      userName: "<%= user.fullName %>",
      userId: "<%= user._id %>",
    };

    if (socket) {
      console.log("Sending chat message:", messageData);
      socket.emit("chat-message", messageData);
    } else {
      console.error("Socket not available");
    }

    input.value = "";
    stopTyping();
  }

  function handleChatKeyPress(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendChatMessage();
    } else {
      if (!isTyping) {
        isTyping = true;
        if (socket) {
          socket.emit("typing-start", {
            groupId: groupId,
            userName: "<%= user.fullName %>",
            userId: "<%= user._id %>",
          });
        }
      }

      clearTimeout(typingTimer);
      typingTimer = setTimeout(stopTyping, 1000);
    }
  }

  function stopTyping() {
    if (isTyping) {
      isTyping = false;
      if (socket) {
        socket.emit("typing-stop", {
          groupId: groupId,
          userId: "<%= user._id %>",
        });
      }
    }
  }

  function showTypingIndicator(userName, userId) {
    if (userId === "<%= user._id %>") return;

    const indicator = getElement("typingIndicator");
    const typingUsers = getElement("typingUsers");

    if (indicator && typingUsers) {
      typingUsers.textContent = userName;
      indicator.style.display = "block";
      scrollChatToBottom();
    }
  }

  function hideTypingIndicator(userId) {
    // If no userId provided, hide for all
    if (!userId || userId === "<%= user._id %>") {
      const indicator = getElement("typingIndicator");
      if (indicator) {
        indicator.style.display = "none";
      }
      return;
    }

    // Only hide for specific user (you might want to implement multi-user typing)
    const indicator = getElement("typingIndicator");
    if (indicator) {
      indicator.style.display = "none";
    }
  }

  function updateOnlineCount(count) {
    const onlineCount = getElement("onlineCount");
    if (onlineCount) {
      onlineCount.textContent = count;
    }
  }

  function scrollChatToBottom() {
    const container = getElement("chatMessages");
    if (container) {
      container.scrollTop = container.scrollHeight;
    }
  }

  // Initialize socket once when page loads
  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM loaded, initializing socket...");
    initializeSocket();
  });
</script>
